<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Serialization to the DjVu transfer format."><title>sndjvu_format::ser - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../static.files/rustdoc-804b98a1284a310a.css"><meta name="rustdoc-vars" data-root-path="../../" data-static-root-path="../../static.files/" data-current-crate="sndjvu_format" data-themes="" data-resource-suffix="" data-rustdoc-version="1.77.0-nightly (2d7be7393 2023-12-23)" data-channel="nightly" data-search-js="search-2b6ce74ff89ae146.js" data-settings-js="settings-4313503d2e1961c2.js" ><script src="../../static.files/storage-f2adc0d6ca4d09fb.js"></script><script defer src="../sidebar-items.js"></script><script defer src="../../static.files/main-305769736d49e732.js"></script><noscript><link rel="stylesheet" href="../../static.files/noscript-feafe1bb7466e4bd.css"></noscript><link rel="alternate icon" type="image/png" href="../../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../../sndjvu_format/index.html">sndjvu_format</a><span class="version">0.2.0</span></h2></div><h2 class="location"><a href="#">Module ser</a></h2><div class="sidebar-elems"><section><ul class="block"><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li><li><a href="#traits">Traits</a></li><li><a href="#functions">Functions</a></li></ul></section><h2><a href="../index.html">In crate sndjvu_format</a></h2></div></nav><div class="sidebar-resizer"></div>
    <main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><div id="sidebar-button" tabindex="-1"><a href="../../sndjvu_format/all.html" title="show sidebar"></a></div><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" tabindex="-1"><a href="../../help.html" title="help">?</a></div><div id="settings-menu" tabindex="-1"><a href="../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Module <a href="../index.html">sndjvu_format</a>::<wbr><a class="mod" href="#">ser</a><button id="copy-path" title="Copy item path to clipboard"><img src="../../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="src" href="../../src/sndjvu_format/ser.rs.html#1-1186">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Serialization to the DjVu transfer format.</p>
<p>If you have a Rust data type that represents a DjVu document, implementing this module’s
<a href="trait.Serialize.html" title="trait sndjvu_format::ser::Serialize"><code>Serialize</code></a> trait allows you to turn a value of that type into a blob of bytes in the
transfer format. The structure of the document is expressed by a sequence of method calls on
various “serializer” objects, such as <a href="struct.Serializer.html" title="struct sndjvu_format::ser::Serializer"><code>Serializer</code></a>, <a href="enum.SerializeMultiPageBundled.html" title="enum sndjvu_format::ser::SerializeMultiPageBundled"><code>SerializeMultiPageBundled</code></a>, etc. This
approach should be familiar from APIs like <code>std::fmt::Debug</code> and <code>serde::Serialize</code>.</p>
<h3 id="two-pass-approach"><a href="#two-pass-approach">Two-pass approach</a></h3>
<p>Various fields in the DjVu transfer format describe the size/length or offset of some part of
the document. Let’s call these “length fields”. A core goal of this module is to take complete
responsibility for computing the correct values for such fields, since these computations are
tightly coupled to the gritty details of the transfer format.</p>
<p>Length fields present some obstacles to an elegant serialization API. Consider the <code>DIRM</code>
chunk, which appears at the beginning of a multi-page document and contains some metadata about
the components, including their offsets and sizes. The offsets appear in the “plain”
(uncompressed) portion of the <code>DIRM</code> chunk, but the sizes are BZZ-compressed. This makes it
impossible to emit a well-formed <code>DIRM</code> chunk until we know the entire structure of the
document in detail, so that we can compute the size of each component, compress that data,
and then compute the final offset of each component. (Because the <code>DIRM</code> chunk appears before
the components, and because the size of the BZZ-compressed portion can’t be determined without
compressing the exact data in question, we really have to do things in this order.)</p>
<p>The only solution, if we care about hiding the intricacies of the transfer format from
downstream, is to split serialization into two passes. On the first pass, we don’t emit any
bytes, but only collect enough information to compute the value of every length field. On the
second pass, we use that stored information to emit the bytes of the document, in order, with
their correct values.</p>
<p>The trick that this module pulls off is to <em>encapsulate</em> the two-pass nature of serialization.
You just implement <a href="trait.Serialize.html" title="trait sndjvu_format::ser::Serialize"><code>Serialize</code></a>, and a function like <a href="fn.to_vec.html" title="fn sndjvu_format::ser::to_vec"><code>to_vec</code></a> takes care internally of
calling <a href="trait.Serialize.html#tymethod.serialize" title="method sndjvu_format::ser::Serialize::serialize"><code>Serialize::serialize</code></a> twice, with two different <a href="struct.Serializer.html" title="struct sndjvu_format::ser::Serializer"><code>Serializer</code></a>s, one for the first
pass and one for the second.</p>
</div></details><h2 id="structs" class="section-header"><a href="#structs">Structs</a></h2><ul class="item-table"><li><div class="item-name"><a class="struct" href="struct.AnnotBuf.html" title="struct sndjvu_format::ser::AnnotBuf">AnnotBuf</a></div><div class="desc docblock-short">Builder for the (uncompressed) data in an <code>ANTa</code> or <code>ANTz</code> chunk.</div></li><li><div class="item-name"><a class="struct" href="struct.BookmarkBuf.html" title="struct sndjvu_format::ser::BookmarkBuf">BookmarkBuf</a></div><div class="desc docblock-short">Builder for the (uncompressed) data in a <code>NAVM</code> chunk.</div></li><li><div class="item-name"><a class="struct" href="struct.Error.html" title="struct sndjvu_format::ser::Error">Error</a></div><div class="desc docblock-short">An error encountered during serialization.</div></li><li><div class="item-name"><a class="struct" href="struct.Okay.html" title="struct sndjvu_format::ser::Okay">Okay</a></div><div class="desc docblock-short">Opaque token returned from successful serialization.</div></li><li><div class="item-name"><a class="struct" href="struct.SerializeBg44Chunks.html" title="struct sndjvu_format::ser::SerializeBg44Chunks">SerializeBg44Chunks</a></div><div class="desc docblock-short">Serializer for a sequence of <code>BG44</code> chunks within a <code>DJVI</code> or <code>DJVU</code> component.</div></li><li><div class="item-name"><a class="struct" href="struct.SerializeComponents.html" title="struct sndjvu_format::ser::SerializeComponents">SerializeComponents</a></div><div class="desc docblock-short">Serializer for the components of a multi-page document.</div></li><li><div class="item-name"><a class="struct" href="struct.SerializeElements.html" title="struct sndjvu_format::ser::SerializeElements">SerializeElements</a></div><div class="desc docblock-short">Serializer for the elements of a <code>DJVU</code> or <code>DJVI</code> component.</div></li><li><div class="item-name"><a class="struct" href="struct.SerializeMultiPageHead.html" title="struct sndjvu_format::ser::SerializeMultiPageHead">SerializeMultiPageHead</a></div><div class="desc docblock-short">Serializer for the “head” data of a multi-page document (<code>DIRM</code> and <code>NAVM</code> chunks).</div></li><li><div class="item-name"><a class="struct" href="struct.SerializeThumbnails.html" title="struct sndjvu_format::ser::SerializeThumbnails">SerializeThumbnails</a></div><div class="desc docblock-short">Serializer for the chunks of a <code>THUM</code> component.</div></li><li><div class="item-name"><a class="struct" href="struct.Serializer.html" title="struct sndjvu_format::ser::Serializer">Serializer</a></div><div class="desc docblock-short">The starting point for serialization.</div></li><li><div class="item-name"><a class="struct" href="struct.TxtBuf.html" title="struct sndjvu_format::ser::TxtBuf">TxtBuf</a></div><div class="desc docblock-short">Builder for the (uncompressed) data in a <code>TXTz</code> chunk.</div></li><li><div class="item-name"><a class="struct" href="struct.ZoneBuf.html" title="struct sndjvu_format::ser::ZoneBuf">ZoneBuf</a></div><div class="desc docblock-short">Builder for the “zones” data in a <code>TXTa</code> chunk.</div></li></ul><h2 id="enums" class="section-header"><a href="#enums">Enums</a></h2><ul class="item-table"><li><div class="item-name"><a class="enum" href="enum.SerializeMultiPageBundled.html" title="enum sndjvu_format::ser::SerializeMultiPageBundled">SerializeMultiPageBundled</a></div><div class="desc docblock-short">Serializer for a bundled multi-page document.</div></li></ul><h2 id="traits" class="section-header"><a href="#traits">Traits</a></h2><ul class="item-table"><li><div class="item-name"><a class="trait" href="trait.Serialize.html" title="trait sndjvu_format::ser::Serialize">Serialize</a></div><div class="desc docblock-short">Interface for describing the structure of a DjVu document.</div></li></ul><h2 id="functions" class="section-header"><a href="#functions">Functions</a></h2><ul class="item-table"><li><div class="item-name"><a class="fn" href="fn.to_vec.html" title="fn sndjvu_format::ser::to_vec">to_vec</a></div><div class="desc docblock-short">Serialize a document into a buffer of bytes.</div></li><li><div class="item-name"><a class="fn" href="fn.to_writer.html" title="fn sndjvu_format::ser::to_writer">to_writer</a><span class="stab portability" title="Available on crate feature `std` only"><code>std</code></span></div><div class="desc docblock-short">Serialize a document into a provided writer.</div></li></ul></section></div></main></body></html>